# 1. Executive Summary
- üî¥ **–£–¥–∞–ª—ë–Ω–Ω–æ–µ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏–µ –±–µ–∑ –≤–∞–ª–∏–¥–∞—Ü–∏–∏.** –≠–Ω–¥–ø–æ–∏–Ω—Ç `calculate` ( `mcp_server/server.py:90-105`) –Ω–∞–ø—Ä—è–º—É—é –ø—Ä–æ–∫–∏–¥—ã–≤–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ –≤ `simple_eval`, —á—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –≤—ã–ø–æ–ª–Ω–∏—Ç—å —Ä–µ—Å—É—Ä—Å–æ—ë–º–∫–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ –∏ –ø–æ–ª–æ–∂–∏—Ç—å —Å–µ—Ä–≤–µ—Ä.
- üî¥ **–õ—é–±–æ–µ –Ω–µ‚Äë—Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ª–æ–º–∞–µ—Ç –¥–∏–∞–ª–æ–≥.** –í `telegram_bot/bot.py:269-278` –≤ OpenAI –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è `message.text` –±–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏; –¥–ª—è —Ñ–æ—Ç–æ/—Å—Ç–∏–∫–µ—Ä–æ–≤ `text=None`, —á—Ç–æ –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–µ –∏ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –¥–∏–∞–ª–æ–≥.
- üî¥ **–ö–æ–Ω—Ç–µ–∫—Å—Ç —Ç–µ—Ä—è–µ—Ç—Å—è –ø—Ä–∏ —Ä–µ—Å—Ç–∞—Ä—Ç–µ.** `telegram_bot/bot.py:100-117` —Ö—Ä–∞–Ω–∏—Ç –∏—Å—Ç–æ—Ä–∏—é –ø–µ—Ä–µ–ø–∏—Å–∫–∏ –≤ –ø–∞–º—è—Ç–∏ –ø—Ä–æ—Ü–µ—Å—Å–∞; –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ –±–æ—Ç ‚Äú–∑–∞–±—ã–≤–∞–µ—Ç‚Äù –¥–∏–∞–ª–æ–≥ –∏ –≤—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–∞—á–∏–Ω–∞—é—Ç –∑–∞–Ω–æ–≤–æ, —á—Ç–æ –∫—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è –¥–∏–∞–ª–æ–≥–æ–≤–æ–≥–æ –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞.

# 2. –î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑
## –°–∏–Ω—Ç–∞–∫—Å–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏
- ‚ö†Ô∏è `mcp_server/server.py:46` ‚Äî –ø–æ–ª–µ `arguments: Dict[str, Any] = {}` –≤ `CallToolRequest` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∏–∑–º–µ–Ω—è–µ–º—ã–π –æ–±—ä–µ–∫—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é. Pydantic 2 –∫–æ–ø–∏—Ä—É–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–µ, –Ω–æ —Ç–∞–∫–æ–µ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ –æ—Å—Ç–∞—ë—Ç—Å—è –∏—Å—Ç–æ—á–Ω–∏–∫–æ–º —Å–∫—Ä—ã—Ç—ã—Ö —Å–∞–π–¥‚Äë—ç—Ñ—Ñ–µ–∫—Ç–æ–≤ –∏ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π —Ç–∏–ø–æ–≤.
- ‚ö†Ô∏è `telegram_bot/bot.py:1-95` ‚Äî —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –∏ —Å—Ç—Ä–æ–∫–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ –∑–∞–∫–æ–¥–∏—Ä–æ–≤–∞–Ω—ã —Å –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∞–º–∏ (mojibake). –≠—Ç–æ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –¥–æ–ª–≥, —É—Ö—É–¥—à–∞—é—â–∏–π –ø–æ–¥–¥–µ—Ä–∂–∫—É –∏ –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏—é.

## –õ–æ–≥–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏
- üî¥ `telegram_bot/bot.py:269-278` ‚Äî –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–µ —Ñ–∏–ª—å—Ç—Ä—É–µ—Ç —Å–æ–±—ã—Ç–∏—è –±–µ–∑ `message.text`, –∏–∑-–∑–∞ —á–µ–≥–æ –ª—é–±–æ–µ –≥–æ–ª–æ—Å–æ–≤–æ–µ/—Ñ–æ—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ –∏—Å–∫–ª—é—á–µ–Ω–∏—é –≤ OpenAI SDK –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç —Ç–æ–ª—å–∫–æ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –∏–∑–≤–∏–Ω–µ–Ω–∏–µ.
- üî¥ `mcp_server/server.py:90-105` ‚Äî `simple_eval(expression)` –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –¥–æ –ª—é–±–æ–π –≤–∞–ª–∏–¥–∞—Ü–∏–∏; –≤—ã—Ä–∞–∂–µ–Ω–∏–µ –≤—Ä–æ–¥–µ `10**1000000` –∏–ª–∏ —Ü–µ–ø–æ—á–∫–∏ –¥–µ–ª–µ–Ω–∏–π –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä –∏ –ø–∞–º—è—Ç—å –Ω–∞ –¥–ª–∏—Ç–µ–ª—å–Ω–æ–µ –≤—Ä–µ–º—è.
- üü° `telegram_bot/bot.py:145,347,354` ‚Äî –ø—Ä–∞–π—Å-–ª–∏—Å—Ç—ã –ø–æ–º–µ—á–µ–Ω—ã –∑–Ω–∞–∫–æ–º `‚ÇΩ`, —Ö–æ—Ç—è `mcp_server/db.py:45-196` –∑–∞–ø–æ–ª–Ω—è–µ—Ç –∫–∞—Ç–∞–ª–æ–≥ —Ü–µ–Ω–∞–º–∏ –≤ –¥–æ–ª–ª–∞—Ä–∞—Ö. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç –Ω–µ–≤–µ—Ä–Ω—É—é –≤–∞–ª—é—Ç—É –∏ –¥–µ–ª–∞–µ—Ç –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –≤—ã–≤–æ–¥—ã.

## –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- üü° `telegram_bot/mcp_client.py:23-60` ‚Äî –Ω–∞ –∫–∞–∂–¥—ã–π –≤—ã–∑–æ–≤ —Å–æ–∑–¥–∞—ë—Ç—Å—è –Ω–æ–≤—ã–π `httpx.AsyncClient`, —á—Ç–æ –¥–∞—ë—Ç –ª–∏—à–Ω–∏–π TCP-handshake –∏ –æ—Ç–ª–æ–∂–µ–Ω–Ω—ã–µ –∑–∞–∫—Ä—ã—Ç–∏—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π. –ü–æ—Å—Ç–æ—è–Ω–Ω—ã–π –∫–ª–∏–µ–Ω—Ç —Å –æ–¥–Ω–∏–º `Timeout` —É–º–µ–Ω—å—à–∏—Ç –∑–∞–¥–µ—Ä–∂–∫–∏.
- üü° `mcp_server/db.py:30-37` ‚Äî —Ç–∞–±–ª–∏—Ü–∞ `products` –Ω–µ –∏–º–µ–µ—Ç –∏–Ω–¥–µ–∫—Å–æ–≤ –ø–æ `category`, `platform`, `price`. –î–∞–∂–µ –Ω–∞ —Å–æ—Ç–Ω–µ —Å—Ç—Ä–æ–∫ —Ä–∞–∑–Ω–∏—Ü—ã –Ω–µ –≤–∏–¥–Ω–æ, –Ω–æ –ø—Ä–∏ —Ä–æ—Å—Ç–µ –∫–∞—Ç–∞–ª–æ–≥–∞ –∑–∞–ø—Ä–æ—Å—ã –Ω–∞—á–Ω—É—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å –ø–æ–ª–Ω—ã–π —Å–∫–∞–Ω.
- üî¥ `mcp_server/server.py:90-105` ‚Äî –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ª–∏–º–∏—Ç–æ–≤ –ø–æ –¥–ª–∏–Ω–µ –≤—ã—Ä–∞–∂–µ–Ω–∏—è –∏ —á–∏—Å–ª–∞–º –¥–ª—è `calculate` –ø–æ–∑–≤–æ–ª—è–µ—Ç –ø—Ä–æ–≤–æ—Ü–∏—Ä–æ–≤–∞—Ç—å DoS –ø–æ CPU/–ø–∞–º—è—Ç–∏.

## –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π
- üü° `telegram_bot/config.py:11-24` ‚Äî –º–æ–¥—É–ª—å –±—Ä–æ—Å–∞–µ—Ç `ValueError` —Å—Ä–∞–∑—É –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ, –∏–∑-–∑–∞ —á–µ–≥–æ –ª—é–±–∞—è –ø–æ–ø—ã—Ç–∫–∞ –∑–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã/–ª–∏–Ω—Ç–µ—Ä—ã –±–µ–∑ .env –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–∞–¥–∞–µ—Ç, –≤–º–µ—Å—Ç–æ —Ç–æ–≥–æ —á—Ç–æ–±—ã —Å–æ–æ–±—â–∏—Ç—å –æ–± –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–µ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –Ω–∞ —É—Ä–æ–≤–Ω–µ –∑–∞–ø—É—Å–∫–∞.
- üü° `config.py:26` ‚Äî `MCP_SERVER_URL` –∂—ë—Å—Ç–∫–æ —É–∫–∞–∑—ã–≤–∞–µ—Ç `http://localhost:8000`. –î–ª—è staging/production –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è –ø–µ—Ä–µ–∫–æ–º–ø–æ–Ω–æ–≤–∫–∞, –Ω–µ—Ç –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –ø—Ä–µ—Ñ–∏–∫—Å–æ–≤ HTTPS –∏ —Ç–∞–π–º–∞—É—Ç–æ–≤.

## –£–ª—É—á—à–µ–Ω–∏–µ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã
- üü° `telegram_bot/bot.py` ‚Äî 399 —Å—Ç—Ä–æ–∫ –æ–±—ä–µ–¥–∏–Ω—è—é—Ç Telegram-—Ö—ç–Ω–¥–ª–µ—Ä—ã, —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ, HTTP-–≤—ã–∑–æ–≤—ã –∏ —Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞. –ù–µ—Ç —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è –Ω–∞ —Å–µ—Ä–≤–∏—Å—ã (OpenAI, MCP, —Ñ–æ—Ä–º–∞—Ç—Ç–µ—Ä), –ø–æ—ç—Ç–æ–º—É —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∑–∞–º–µ–Ω–∞ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ —Å–ª–æ–∂–Ω—ã.
- üü° `bot.py:100-117` ‚Äî `user_contexts` —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ –ø–∞–º—è—Ç–∏ –ø—Ä–æ—Ü–µ—Å—Å–∞. –ü–æ—Å–ª–µ —Ä–µ—Å—Ç–∞—Ä—Ç–∞ –≤–µ—Å—å –∫–æ–Ω—Ç–µ–∫—Å—Ç —Ç–µ—Ä—è–µ—Ç—Å—è, —á—Ç–æ –º–µ—à–∞–µ—Ç –¥–ª–∏—Ç–µ–ª—å–Ω—ã–º –¥–∏–∞–ª–æ–≥–∞–º –∏ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–º—É –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—é.
- üü¢ `mcp_server/tools.py` –∏ `db.py` –∂—ë—Å—Ç–∫–æ —Å–≤—è–∑–∞–Ω—ã —á–µ—Ä–µ–∑ –≥–ª–æ–±–∞–ª—å–Ω—ã–π —Å–ª–æ–≤–∞—Ä—å `TOOL_FUNCTIONS`; —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ –Ω–∞–±–æ—Ä–∞ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ —Ç—Ä–µ–±—É–µ—Ç –ø—Ä–∞–≤–æ–∫ –≤ –¥–≤—É—Ö —Ñ–∞–π–ª–∞—Ö –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–∏—Å–∞.

## –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è
- üü° `bot.py:279-308` ‚Äî –æ—Ç–ª–∞–¥–æ—á–Ω—ã–µ `print` –≤—ã–≤–æ–¥—è—Ç –ø–µ—Ä–≤—ã–µ 200 —Å–∏–º–≤–æ–ª–æ–≤ –æ—Ç–≤–µ—Ç–∞ –∏ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –í production —ç—Ç–æ —Ä–∏—Å–∫ —É—Ç–µ—á–∫–∏ PII –∏ —Ç–æ–∫–µ–Ω–æ–≤.
- üü° –ê–≤—Ç–æ—Ç–µ—Å—Ç—ã –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é; –ª—é–±–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –ø–µ—Ä–µ–Ω–æ—Å–∏—Ç—Å—è –≤—Å–ª–µ–ø—É—é –∏ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –≤—Ä—É—á–Ω—É—é.
- üü¢ –ù–µ—Ç –º–µ—Ç—Ä–∏–∫/health-check'–æ–≤ –Ω–∏ –¥–ª—è –±–æ—Ç–∞, –Ω–∏ –¥–ª—è MCP, –ø–æ—ç—Ç–æ–º—É –Ω–∞–±–ª—é–¥–∞–µ–º–æ—Å—Ç—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∞ stdout.

## –ü—Ä–æ–±–ª–µ–º—ã –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è—Ö
- üü° `telegram_bot/requirements.txt` ‚Äî `openai>=1.0.0` –ø–æ–∑–≤–æ–ª—è–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤–µ—Ä—Å–∏–∏ –¥–æ –ø–æ—è–≤–ª–µ–Ω–∏—è `gpt-4o-mini`; –Ω–∞—á–∏–Ω–∞—è —Å 1.40 API —Å–º–µ—â–∞–µ—Ç—Å—è –∫ Responses API. –ù—É–∂–Ω–æ –∂—ë—Å—Ç–∫–æ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å –º–∏–Ω–∏–º–∞–ª—å–Ω—É—é —Å–æ–≤–º–µ—Å—Ç–∏–º—É—é –≤–µ—Ä—Å–∏—é (1.40.x) –∏ –≤–µ—Ä—Ö–Ω—é—é –≥—Ä–∞–Ω–∏—Ü—É.
- üü° `mcp_server/requirements.txt` ‚Äî `python-dotenv` –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –Ω–∏ –≤ –æ–¥–Ω–æ–º —Ñ–∞–π–ª–µ —Å–µ—Ä–≤–µ—Ä–∞, –Ω–æ —Ç—è–Ω–µ—Ç –ª–∏—à–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏.
- üü¢ –î–ª—è `aiogram` —É–∫–∞–∑–∞–Ω —Ç–æ–ª—å–∫–æ –Ω–∏–∂–Ω–∏–π –ø–æ—Ä–æ–≥ `>=3.0.0`; –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ 4.x –±–µ–∑ –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ –±–æ—Ç –ø–µ—Ä–µ—Å—Ç–∞–Ω–µ—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å—Å—è.

# 3. –ú–µ—Ç—Ä–∏–∫–∏
| –ú–µ—Ç—Ä–∏–∫–∞ | –ó–Ω–∞—á–µ–Ω–∏–µ | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π |
| --- | --- | --- |
| Python-—Ñ–∞–π–ª–æ–≤ | 6 | bot/config/mcp_client + db/server/tools |
| –°—Ç—Ä–æ–∫ Python-–∫–æ–¥–∞ | 1‚ÄØ110 | bot.py –∑–∞–Ω–∏–º–∞–µ—Ç 36% –≤—Å–µ–≥–æ –∫–æ–¥–∞ |
| –¢–µ—Å—Ç–æ–≤ | 0 | –Ω–µ—Ç –Ω–∏ unit-, –Ω–∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö –ø—Ä–æ–≤–µ—Ä–æ–∫ |
| –°—Ä–µ–¥–Ω–∏–π —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ | ~185 —Å—Ç—Ä–æ–∫ | —Å–≤–∏–¥–µ—Ç–µ–ª—å—Å—Ç–≤–æ –º–æ–Ω–æ–ª–∏—Ç–Ω—ã—Ö –º–æ–¥—É–ª–µ–π |

**–û—Ü–µ–Ω–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞:** 4/10 ‚Äî –∫–ª—é—á–µ–≤–æ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω, –Ω–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ –∫–∞—á–µ—Å—Ç–≤–æ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —Ç—Ä–µ–±—É—é—Ç –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–≥–æ –≤–Ω–∏–º–∞–Ω–∏—è.

# 4. –†–µ–∑—é–º–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–≤
- üî¥ –ó–∞—â–∏—Ç–∏—Ç—å `calculate` –æ—Ç –∑–ª–æ—É–ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–π, –¥–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –Ω–µ‚Äë—Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –∏ –≤—ã–Ω–µ—Å—Ç–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ –ø–∞–º—è—Ç–∏ –±–æ—Ç–∞.
- üü° –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ë–î (–∏–Ω–¥–µ–∫—Å—ã) –∏ —Å–µ—Ç–µ–≤—ã–µ –∫–ª–∏–µ–Ω—Ç—ã, —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –≤–∞–ª—é—Ç—É/—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ü–µ–Ω.
- üü¢ –†–∞–∑–±–∏—Ç—å `bot.py` –Ω–∞ —Å–µ—Ä–≤–∏—Å—ã, –¥–æ–±–∞–≤–∏—Ç—å –Ω–∞–±–ª—é–¥–∞–µ–º–æ—Å—Ç—å –∏ –∞–≤—Ç–æ—Ç–µ—Å—Ç—ã, –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏.

# 5. –ü–ª–∞–Ω —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞
## CRITICAL
### 5.1 –ó–∞—â–∏—Ç–∏—Ç—å `calculate` –æ—Ç –≤—Ä–µ–¥–æ–Ω–æ—Å–Ω—ã—Ö –≤—ã—Ä–∞–∂–µ–Ω–∏–π
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** CRITICAL  
**–ü—Ä–æ–±–ª–µ–º–∞ / –í—ã–∏–≥—Ä—ã—à:** `mcp_server/server.py:90-105` –≤—ã—á–∏—Å–ª—è–µ—Ç –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ, —á—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç DoS. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–ª–∏–Ω—ã –∏ whitelist —Å–∏–º–≤–æ–ª–æ–≤ —É—Å—Ç—Ä–∞–Ω—è–µ—Ç –∫–ª–∞—Å—Å –∞—Ç–∞–∫ –∏ —Å—Ç–∞–±–∏–ª–∏–∑–∏—Ä—É–µ—Ç —Å–µ—Ä–≤–∏—Å.  
**–§–∞–π–ª:** `mcp_server/server.py:90-105`  
**–ë—ã–ª–æ:**
```python
if tool_name == "calculate":
    expression = arguments.get("expression", "")
    ...
    result = simple_eval(expression)
    return CallToolResponse(ok=True, result=result)
```
**–°—Ç–∞–ª–æ:**
```python
if tool_name == "calculate":
    expression = (arguments.get("expression") or "").strip()
    if len(expression) > 64 or not re.fullmatch(r"[0-9()+\-*/.\s]+", expression):
        return CallToolResponse(ok=False, error="–î–æ–ø—É—Å—Ç–∏–º—ã —Ç–æ–ª—å–∫–æ —á–∏—Å–ª–∞ –∏ +-*/().")
    result = simple_eval(expression, names={}, functions={})
    return CallToolResponse(ok=True, result=result)
```
**–¢–µ—Å—Ç—ã:** `pytest tests/test_server.py::test_calculate_validation` (–Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å).  
**–†–∏—Å–∫–∏:** –≤—ã—Ä–∞–∂–µ–Ω–∏—è —Å –∑–∞–ø—è—Ç—ã–º–∏/—Å—Ç–µ–ø–µ–Ω—è–º–∏ –ø–µ—Ä–µ—Å—Ç–∞–Ω—É—Ç —Ä–∞–±–æ—Ç–∞—Ç—å, –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è –æ–±–Ω–æ–≤–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é.  
**–û—Ç–∫–∞—Ç:** `git checkout -- mcp_server/server.py`.

### 5.2 –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –Ω–µ‚Äë—Ç–µ–∫—Å—Ç–æ–≤—ã—Ö –∞–ø–¥–µ–π—Ç–æ–≤ –≤ –±–æ—Ç–µ
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** CRITICAL  
**–ü—Ä–æ–±–ª–µ–º–∞ / –í—ã–∏–≥—Ä—ã—à:** `bot.py:269-278` –±–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç `None` –≤ OpenAI. –ü—Ä–æ–≤–µ—Ä–∫–∞ `message.text` –∏ –æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞—é—Ç –æ—à–∏–±–∫–∏ –∏ —É–º–µ–Ω—å—à–∞—é—Ç —Ä–∞—Å—Ö–æ–¥ —Ç–æ–∫–µ–Ω–æ–≤.  
**–§–∞–π–ª:** `telegram_bot/bot.py:269-278`  
**–ë—ã–ª–æ:**
```python
user_id = message.from_user.id
user_text = message.text
add_to_context(user_id, "user", user_text)
gpt_response = await call_openai(user_text, user_id)
```
**–°—Ç–∞–ª–æ:**
```python
user_id = message.from_user.id
user_text = (message.text or "").strip()
if not user_text:
    await message.answer("–û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ, —á—Ç–æ–±—ã —è —Å–º–æ–≥ –ø–æ–º–æ—á—å üëç")
    return
add_to_context(user_id, "user", user_text)
gpt_response = await call_openai(user_text, user_id)
```
**–¢–µ—Å—Ç—ã:** `pytest tests/test_bot.py::test_process_user_message_skip_non_text` (–¥–æ–±–∞–≤–∏—Ç—å —Å aiogram Bot mock).  
**–†–∏—Å–∫–∏:** –Ω—É–∂–Ω–æ –ª–æ–∫–∞–ª–∏–∑–æ–≤–∞—Ç—å –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ –∏ —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –æ–Ω–æ –Ω–µ —Ü–∏–∫–ª–∏—á–Ω–æ.  
**–û—Ç–∫–∞—Ç:** `git checkout -- telegram_bot/bot.py`.

### 5.3 –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç –≤–Ω–µ –ø–∞–º—è—Ç–∏ –ø—Ä–æ—Ü–µ—Å—Å–∞
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** CRITICAL  
**–ü—Ä–æ–±–ª–µ–º–∞ / –í—ã–∏–≥—Ä—ã—à:** `telegram_bot/bot.py:100-117` —Ö—Ä–∞–Ω–∏—Ç –∏—Å—Ç–æ—Ä–∏—é –≤ `defaultdict(list)`; –ø—Ä–∏ —Ä–µ—Å—Ç–∞—Ä—Ç–µ –∏–ª–∏ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–º –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Ç–µ—Ä—è—é—Ç –¥–∏–∞–ª–æ–≥. –ü–µ—Ä–µ–Ω–æ—Å –≤ Redis/SQLite –∏–ª–∏ —Ö–æ—Ç—è –±—ã —Ñ–∞–π–ª–æ–≤—ã–π –∫–µ—à –¥–µ–ª–∞–µ—Ç –ø–æ–≤–µ–¥–µ–Ω–∏–µ –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º—ã–º –∏ –Ω–µ –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã–º –∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É –ø—Ä–æ—Ü–µ—Å—Å—É.  
**–§–∞–π–ª:** `telegram_bot/bot.py:28-117`  
**–ë—ã–ª–æ:**
```python
user_contexts: Dict[int, List[Dict[str, str]]] = defaultdict(list)

def get_context(user_id: int) -> List[Dict[str, str]]:
    if user_id not in user_contexts:
        user_contexts[user_id] = []
    return user_contexts[user_id]
```
**–°—Ç–∞–ª–æ:**
```python
from .context_store import ContextStore
context_store = ContextStore(ttl_minutes=120)

def get_context(user_id: int) -> List[Dict[str, str]]:
    return context_store.get(user_id)
```
**–¢–µ—Å—Ç—ã:** `pytest tests/test_context_store.py::test_context_persistence`.  
**–†–∏—Å–∫–∏:** –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è –Ω–æ–≤–∞—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞; –ø—Ä–∏ –æ—à–∏–±–æ—á–Ω–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –±–æ—Ç –Ω–µ –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è.  
**–û—Ç–∫–∞—Ç:** `git checkout -- telegram_bot/bot.py telegram_bot/context_store.py`.

## HIGH
### 5.4 –î–æ–±–∞–≤–∏—Ç—å –∏–Ω–¥–µ–∫—Å—ã –ø–æ —á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–º –ø–æ–ª—è–º –≤ –ë–î
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** HIGH  
**–ü—Ä–æ–±–ª–µ–º–∞ / –í—ã–∏–≥—Ä—ã—à:** `db.py:30-37` —Å–æ–∑–¥–∞—ë—Ç —Ç–∞–±–ª–∏—Ü—É –±–µ–∑ –∏–Ω–¥–µ–∫—Å–æ–≤; –ø–æ–∏—Å–∫ –ø–æ –∂–∞–Ω—Ä—É/–ø–ª–∞—Ç—Ñ–æ—Ä–º–µ –∑–∞—Å—Ç–∞–≤–ª—è–µ—Ç SQLite —Å–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –≤—Å—é —Ç–∞–±–ª–∏—Ü—É. –ò–Ω–¥–µ–∫—Å—ã —É–º–µ–Ω—å—à–∞—é—Ç –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞ –ø—Ä–∏ —Ä–æ—Å—Ç–µ –∫–∞—Ç–∞–ª–æ–≥–∞ –∏ —Å–Ω–∏–∂–∞—é—Ç –Ω–∞–≥—Ä—É–∑–∫—É.  
**–§–∞–π–ª:** `mcp_server/db.py:30-37`  
**–ë—ã–ª–æ:**
```sql
CREATE TABLE IF NOT EXISTS products (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name TEXT NOT NULL,
    category TEXT NOT NULL,
    price REAL NOT NULL,
    platform TEXT NOT NULL,
    is_featured INTEGER NOT NULL DEFAULT 0
);
```
**–°—Ç–∞–ª–æ:**
```sql
CREATE TABLE IF NOT EXISTS products (...);
CREATE INDEX IF NOT EXISTS idx_products_category ON products(category);
CREATE INDEX IF NOT EXISTS idx_products_platform ON products(platform);
CREATE INDEX IF NOT EXISTS idx_products_price ON products(price);
```
**–¢–µ—Å—Ç—ã:** `pytest tests/test_db.py::test_indexes_exist` + —Ä—É—á–Ω–æ–π –ø—Ä–æ–≥–æ–Ω `uvicorn mcp_server.server:app`.  
**–†–∏—Å–∫–∏:** –Ω–µ–±–æ–ª—å—à–æ–µ —É–≤–µ–ª–∏—á–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ –ë–î –∏ –≤—Ä–µ–º–µ–Ω–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏.  
**–û—Ç–∫–∞—Ç:** `git checkout -- mcp_server/db.py`.

## MEDIUM
### 5.5 –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å HTTP-–∫–ª–∏–µ–Ω—Ç MCP
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** MEDIUM  
**–ü—Ä–æ–±–ª–µ–º–∞ / –í—ã–∏–≥—Ä—ã—à:** `mcp_client.py:23,56` —Å–æ–∑–¥–∞—ë—Ç `httpx.AsyncClient` –Ω–∞ –∫–∞–∂–¥—ã–π –∑–∞–ø—Ä–æ—Å. –í—ã–Ω–æ—Å –∫–ª–∏–µ–Ω—Ç–∞ –Ω–∞ —É—Ä–æ–≤–µ–Ω—å –º–æ–¥—É–ª—è —É–º–µ–Ω—å—à–∏—Ç –∑–∞–¥–µ—Ä–∂–∫–∏ –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç–∫—Ä—ã—Ç—ã—Ö —Å–æ–∫–µ—Ç–æ–≤.  
**–§–∞–π–ª:** `telegram_bot/mcp_client.py:17-60`  
**–ë—ã–ª–æ:**
```python
async with httpx.AsyncClient(timeout=10.0) as client:
    response = await client.post(url, json=payload)
```
**–°—Ç–∞–ª–æ:**
```python
_client = httpx.AsyncClient(timeout=10.0)

async def call_tool(...):
    response = await _client.post(url, json=payload)
```
**–¢–µ—Å—Ç—ã:** `pytest tests/test_mcp_client.py::test_client_reuse` (—Å monkeypatch httpx).  
**–†–∏—Å–∫–∏:** –Ω—É–∂–Ω–æ –∑–∞–∫—Ä—ã–≤–∞—Ç—å –∫–ª–∏–µ–Ω—Ç –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (hook –≤ shutdown).  
**–û—Ç–∫–∞—Ç:** `git checkout -- telegram_bot/mcp_client.py`.

## LOW
### 5.6 –ü–µ—Ä–µ–≤–µ—Å—Ç–∏ –æ—Ç–ª–∞–¥–æ—á–Ω—ã–π –≤—ã–≤–æ–¥ –Ω–∞ logger c –º–∞—Å–∫–∏—Ä–æ–≤–∞–Ω–∏–µ–º
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** LOW  
**–ü—Ä–æ–±–ª–µ–º–∞ / –í—ã–∏–≥—Ä—ã—à:** `bot.py:279-308` –ø–∏—à–µ—Ç PII –≤ stdout. –ó–∞–º–µ–Ω–∞ –Ω–∞ `logging.getLogger(__name__)` —Å —É—Å–µ—á—ë–Ω–Ω—ã–º —Ç–µ–∫—Å—Ç–æ–º –∏–∑–±–∞–≤–∏—Ç –æ—Ç —É—Ç–µ—á–µ–∫ –∏ –ø–æ–∑–≤–æ–ª–∏—Ç –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—Ç—å —É—Ä–æ–≤–Ω–∏ –ª–æ–≥–æ–≤.  
**–§–∞–π–ª:** `telegram_bot/bot.py:26,279-308`  
**–ë—ã–ª–æ:**
```python
print(f"[DEBUG] GPT Response: {gpt_response[:200]}")
...
print(f"[DEBUG] Parsed tool call: {tool_call}")
```
**–°—Ç–∞–ª–æ:**
```python
logger = logging.getLogger(__name__)
...
logger.debug("LLM response preview: %s", gpt_response[:80].replace("\n", " "))
logger.debug("Tool call: %s", json.dumps(tool_call)[:120])
```
**–¢–µ—Å—Ç—ã:** `pytest tests/test_bot.py::test_debug_logging_mask` (–ø—Ä–æ–≤–µ—Ä–∫–∞ mock logger).  
**–†–∏—Å–∫–∏:** —Ç—Ä–µ–±—É–µ—Ç—Å—è –±–∞–∑–æ–≤–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–≥–µ—Ä–∞, –∏–Ω–∞—á–µ —Å–æ–æ–±—â–µ–Ω–∏—è –º–æ–≥—É—Ç –Ω–µ –ø–æ—è–≤–∏—Ç—å—Å—è –≤ dev-–∫–æ–Ω—Å–æ–ª–∏.  
**–û—Ç–∫–∞—Ç:** `git checkout -- telegram_bot/bot.py`.

# 6. –ó–∞–∫–ª—é—á–µ–Ω–∏–µ
- **–û—Ü–µ–Ω–∫–∞ –∫–æ–¥–∞:** 4/10 ‚Äî —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å —Ä–∞–±–æ—Ç–∞–µ—Ç, –Ω–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ —É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å –ø–æ–∫–∞ –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç production-—É—Ä–æ–≤–Ω—é.
- **–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:** –í—ã—Å–æ–∫–∏–π ‚Äî –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–æ –ø—Ä–æ–±–ª–µ–º –∏—Å–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω—ã–º–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏ (–∫–æ–Ω—Ñ–∏–≥, –≤–∞–ª–∏–¥–∞—Ü–∏—è, –∏–Ω–¥–µ–∫—Å—ã) –±–µ–∑ —Ä–∞–¥–∏–∫–∞–ª—å–Ω–æ–π –ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∫–∏ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã.

–°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏ –ø–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –∑–∞–¥–∞—á: –¥–æ–±–∞–≤–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ç–µ—Å—Ç—ã –¥–ª—è OpenAI –∏ MCP-—Å–ª–æ—ë–≤, –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞—Ç—å –≤–∞–ª—é—Ç—É –∫–∞—Ç–∞–ª–æ–≥–∞ –∏ —Ä–∞–∑–±–∏—Ç—å `bot.py` –Ω–∞ –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã–µ —Å–µ—Ä–≤–∏—Å—ã –¥–ª—è –ª—É—á—à–µ–π —Å–æ–ø—Ä–æ–≤–æ–∂–¥–∞–µ–º–æ—Å—Ç–∏.
